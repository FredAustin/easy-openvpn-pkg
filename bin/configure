#!/bin/sh
#
# Copyright (C) 2017 Canonical Ltd
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 3 as
# published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

PROFILE="${SNAP_DATA}/easy-openvpn.profile"

test -f $PROFILE && rm $PROFILE

if ! debug=$(snapctl get debug); then
    echo "Failed to get debug option."
    exit 1
fi

if ! nopasswd=$(snapctl get nopasswd); then
    echo "Failed to get nopasswd option."
    exit 1
fi

# global env variables
echo "export OPENVPN=$SNAP_DATA/openvpn" > $PROFILE
echo "export EASYRSA=$SNAP/usr/local/easyrsa">> $PROFILE
echo "export EASYRSA_PKI=$SNAP_DATA/openvpn/pki">> $PROFILE
echo "export EASYRSA_VARS_FILE=$SNAP_DATA/openvpn/vars">> $PROFILE
echo "export PATH=$SNAP/usr/local/easyrsa:$SNAP/usr/sbin:$SNAP/usr/bin:$SNAP/sbin:$SNAP/bin:$PATH">> $PROFILE

echo "export DEBUG=$debug" >> $PROFILE
echo "export NOPASSWD=$nopasswd" >> $PROFILE

# Set default cn and call easy-rsa explicitly in batch mode.
# It's helpful to execute spread test in non-interactive mode.
if [ "$nopasswd" = "1" ]; then
    # Ugly, set env var and pass it to ovpn.
    # export nopass=1 makes more sense but this is the least code changes.
    echo "export nopass=nopass" >> $PROFILE
    echo "export EASYRSA_BATCH=1" >> $PROFILE
    echo "export EASYRSA_REQ_CN=SNAPPY_SPREAD_TEST" >> $PROFILE
fi

chmod 600 $PROFILE
