#!/bin/sh

PROFILE="${SNAP_DATA}/easy-openvpn.profile"

test -f $PROFILE && rm $PROFILE

if ! debug=$(snapctl get debug); then
    echo "Failed to get debug option."
    exit 1
fi

if ! nopasswd=$(snapctl get nopasswd); then
    echo "Failed to get nopasswd option."
    exit 1
fi

# global env variables
echo "export OPENVPN=$SNAP_DATA/openvpn" > $PROFILE
echo "export EASYRSA=$SNAP/usr/local/easyrsa">> $PROFILE
echo "export EASYRSA_PKI=$SNAP_DATA/openvpn/pki">> $PROFILE
echo "export EASYRSA_VARS_FILE=$SNAP_DATA/openvpn/vars">> $PROFILE
echo "export PATH=$SNAP/usr/local/easyrsa:$SNAP/usr/sbin:$SNAP/usr/bin:$SNAP/sbin:$SNAP/bin:$PATH">> $PROFILE

echo "export DEBUG=$debug" >> $PROFILE
echo "export NOPASSWD=$nopasswd" >> $PROFILE

# set default cn and call easy-rsa explicitly in batch mode.
# It's helpful to execute spread test in non-interactive mode.
if [ "$nopasswd" = "1" ]; then
    # ugly, set env var and pass it to ovpn.
    # export nopass=1 makes more sense but this is the least code changes.
    echo "export nopass=nopass" >> $PROFILE
    echo "export EASYRSA_BATCH=1" >> $PROFILE
    echo "export EASYRSA_REQ_CN=SNAPPY_SPREAD_TEST" >> $PROFILE
fi

chmod 600 $PROFILE
